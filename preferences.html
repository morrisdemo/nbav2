<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Communication Preferences</title>

  <script
    id="sap-ui-bootstrap"
    src="https://sdk.openui5.org/resources/sap-ui-core.js"
    data-sap-ui-theme="sap_horizon"
    data-sap-ui-libs="sap.m,sap.ui.layout"
    data-sap-ui-async="true"
    data-sap-ui-compatVersion="edge"
    data-sap-ui-preload="async"
  ></script>

  <style>
    html, body, #content { height: 100%; margin: 0; }
    .pageWrap { max-width: 1100px; margin: 0 auto; }
    .muted { opacity: 0.75; }
    .tinyTopPad { padding-top: 0.25rem; }
  </style>
</head>

<body class="sapUiBody sapUiSizeCompact">
  <div id="content"></div>

  <script>
    sap.ui.getCore().attachInit(function () {

      const CHANNELS = [
        { key: "EMAIL", label: "Email" },
        { key: "SMS", label: "SMS" },
        { key: "PUSH", label: "In-App Push" },
        { key: "VOICE", label: "Voice Call" },
        { key: "MAIL", label: "Mail" }
      ];

      const PROCESSES = [
        { id: "BILLING_PAYMENTS", title: "Billing & Payments", desc: "Statements, bills, payment reminders, confirmations." },
        { id: "USAGE_ALERTS", title: "Usage Alerts", desc: "High usage, threshold alerts, leak alerts (if applicable)." },
        { id: "OUTAGES", title: "Outages", desc: "Service interruptions, restoration updates, emergency notices." },
        { id: "PROGRAM_RECS", title: "Program Recommendations", desc: "Rebates, assistance programs, time-of-use suggestions." },
        { id: "PROFILE_UPDATES", title: "Profile Updates", desc: "Account changes, security notices, preference confirmations." }
      ];

      const STORAGE_KEY = "scv2_comm_prefs_v1d";

      function newBlankPrefs() {
        return PROCESSES.map(p => ({
          processId: p.id,
          processTitle: p.title,
          channels: CHANNELS.reduce((acc, c) => (acc[c.key] = false, acc), {}),
          notes: ""
        }));
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) { return null; }
      }

      function saveState(state) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state, null, 2));
      }

      function formatNow() {
        return new Date().toLocaleString();
      }

      function isValidEmail(v) {
        if (!v) return true;
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v).trim());
      }

      function isValidPhone(v) {
        if (!v) return true;
        return /^[0-9()+\-.\s]{7,}$/.test(String(v).trim());
      }

      function ensureAtLeastOneContactIfAnyEnabled(model) {
        const data = model.getData();
        const anyEnabled = data.preferences.some(row =>
          Object.values(row.channels || {}).some(Boolean)
        );
        if (!anyEnabled) return true;

        const hasEmail = !!(data.customer.email || "").trim();
        const hasPhone = !!(data.customer.phone || "").trim();
        return hasEmail || hasPhone;
      }

      // --- NEW: normalize "on file" arrays to [{value:"..."}]
      function normalizeValueList(list) {
        if (!Array.isArray(list)) return [];
        if (list.length === 0) return [];
        if (typeof list[0] === "string") {
          return list.map(v => ({ value: v }));
        }
        // already object-ish
        return list.map(x => ({ value: x.value ?? x }));
      }

      // ----------------------------
      // Default state (demo values)
      // ----------------------------
      const defaultState = {
        customer: {
          email: "alex.primary@email.com",
          phone: "+1 (916) 555-0123",
          emailsOnFile: [
            { value: "alex.primary@email.com" },
            { value: "alex.work@email.com" },
            { value: "alex.family@email.com" }
          ],
          phonesOnFile: [
            { value: "+1 (916) 555-0123" },
            { value: "+1 (916) 555-0456" }
          ]
        },
        global: {
          allowMarketing: false,
          quietHours: { enabled: false, start: "21:00", end: "08:00" }
        },
        preferences: newBlankPrefs(),
        meta: { lastSavedAt: "", version: "1.3" }
      };

      const persisted = loadState();
      const initialState = persisted ? persisted : defaultState;

      // Upgrade/normalize persisted state
      initialState.customer = initialState.customer || {};
      initialState.customer.emailsOnFile = normalizeValueList(
        initialState.customer.emailsOnFile ?? defaultState.customer.emailsOnFile
      );
      initialState.customer.phonesOnFile = normalizeValueList(
        initialState.customer.phonesOnFile ?? defaultState.customer.phonesOnFile
      );

      if (!initialState.customer.email) {
        initialState.customer.email = (initialState.customer.emailsOnFile[0]?.value) || "";
      }
      if (!initialState.customer.phone) {
        initialState.customer.phone = (initialState.customer.phonesOnFile[0]?.value) || "";
      }

      const oModel = new sap.ui.model.json.JSONModel(initialState);
      oModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);

      // ----------------------------
      // Header + Contact Card
      // ----------------------------
      const oTitle = new sap.m.Title({ text: "Communication Preferences", level: "H2" });
      const oSub = new sap.m.Text({
        text: "Choose how you want to receive updates by process and channel."
      }).addStyleClass("muted tinyTopPad");

      // FIX: bind to object list {value:"..."} for guaranteed rendering
      const oEmailSelect = new sap.m.Select({
        selectedKey: "{/customer/email}",
        width: "100%",
        items: {
          path: "/customer/emailsOnFile",
          template: new sap.ui.core.Item({ key: "{value}", text: "{value}" }),
          templateShareable: false
        },
        change: function (e) {
          const v = e.getParameter("selectedItem")?.getKey() || "";
          e.getSource().setValueState(isValidEmail(v) ? "None" : "Error");
          e.getSource().setValueStateText(isValidEmail(v) ? "" : "Select a valid email address.");
        }
      });

      const oPhoneSelect = new sap.m.Select({
        selectedKey: "{/customer/phone}",
        width: "100%",
        items: {
          path: "/customer/phonesOnFile",
          template: new sap.ui.core.Item({ key: "{value}", text: "{value}" }),
          templateShareable: false
        },
        change: function (e) {
          const v = e.getParameter("selectedItem")?.getKey() || "";
          e.getSource().setValueState(isValidPhone(v) ? "None" : "Error");
          e.getSource().setValueStateText(isValidPhone(v) ? "" : "Select a valid phone number.");
        }
      });

      const oAllowMarketing = new sap.m.Switch({ state: "{/global/allowMarketing}" });
      const oQuietHoursSwitch = new sap.m.Switch({ state: "{/global/quietHours/enabled}" });

      const oQuietStart = new sap.m.TimePicker({
        value: "{/global/quietHours/start}",
        displayFormat: "HH:mm",
        valueFormat: "HH:mm",
        width: "100%"
      });

      const oQuietEnd = new sap.m.TimePicker({
        value: "{/global/quietHours/end}",
        displayFormat: "HH:mm",
        valueFormat: "HH:mm",
        width: "100%"
      });

      const oContactForm = new sap.ui.layout.form.SimpleForm({
        editable: true,
        layout: "ResponsiveGridLayout",
        labelSpanXL: 4, labelSpanL: 4, labelSpanM: 4, labelSpanS: 12,
        columnsXL: 2, columnsL: 2, columnsM: 2,
        content: [
          new sap.m.Label({ text: "Email" }),
          oEmailSelect,

          new sap.m.Label({ text: "Phone" }),
          oPhoneSelect,

          new sap.m.Label({ text: "Allow Program/Offer Recommendations" }),
          oAllowMarketing,

          new sap.m.Label({ text: "Quiet Hours" }),
          oQuietHoursSwitch,

          new sap.m.Label({ text: "Quiet Hours Start" }),
          oQuietStart,

          new sap.m.Label({ text: "Quiet Hours End" }),
          oQuietEnd
        ]
      });

      const oContactCard = new sap.m.Panel({
        headerText: "Contact & Global Settings",
        expandable: false,
        content: [oContactForm]
      });

      // ----------------------------
      // Preferences Table (matrix)
      // ----------------------------
      const oTable = new sap.m.Table({
        inset: false,
        growing: true,
        growingScrollToLoad: true,
        sticky: ["ColumnHeaders"],
        headerToolbar: new sap.m.Toolbar({
          content: [
            new sap.m.Title({ text: "Preferences by Process & Channel", level: "H3" }),
            new sap.m.ToolbarSpacer(),
            new sap.m.Button({
              text: "Enable All",
              type: "Transparent",
              press: function () {
                const data = oModel.getData();
                data.preferences.forEach(r => Object.keys(r.channels).forEach(k => r.channels[k] = true));
                oModel.refresh(true);
              }
            }),
            new sap.m.Button({
              text: "Disable All",
              type: "Transparent",
              press: function () {
                const data = oModel.getData();
                data.preferences.forEach(r => Object.keys(r.channels).forEach(k => r.channels[k] = false));
                oModel.refresh(true);
              }
            })
          ]
        })
      });

      oTable.addColumn(new sap.m.Column({ width: "18rem", header: new sap.m.Text({ text: "Process" }) }));
      CHANNELS.forEach(c => {
        oTable.addColumn(new sap.m.Column({
          hAlign: "Center",
          header: new sap.m.Text({ text: c.label })
        }));
      });
      oTable.addColumn(new sap.m.Column({ width: "16rem", header: new sap.m.Text({ text: "Notes" }) }));

      function channelSwitchTemplate(channelKey) {
        return new sap.m.Switch({
          state: `{channels/${channelKey}}`,
          customTextOn: "On",
          customTextOff: "Off"
        });
      }

      const oItemTemplate = new sap.m.ColumnListItem({
        vAlign: "Middle",
        cells: [
          new sap.m.VBox({
            items: [
              new sap.m.Text({ text: "{processTitle}" }),
              new sap.m.Text({
                text: {
                  path: "processId",
                  formatter: function (pid) {
                    const p = PROCESSES.find(x => x.id === pid);
                    return p ? p.desc : "";
                  }
                }
              }).addStyleClass("muted")
            ]
          }),
          ...CHANNELS.map(c => new sap.m.HBox({
            justifyContent: "Center",
            items: [channelSwitchTemplate(c.key)]
          })),
          new sap.m.Input({
            value: "{notes}",
            placeholder: "Optionalâ€¦",
            width: "100%"
          })
        ]
      });

      oTable.bindItems({
        path: "/preferences",
        template: oItemTemplate,
        templateShareable: false
      });

      // ----------------------------
      // Footer actions: Save + Cancel
      // ----------------------------
      const oLastSaved = new sap.m.Text({
        text: {
          path: "/meta/lastSavedAt",
          formatter: function (v) { return v ? `Last saved: ${v}` : "Not saved yet"; }
        }
      }).addStyleClass("muted");

      function validateBeforeSave() {
        const data = oModel.getData();
        const emailOk = isValidEmail(data.customer.email);
        const phoneOk = isValidPhone(data.customer.phone);

        oEmailSelect.setValueState(emailOk ? "None" : "Error");
        oPhoneSelect.setValueState(phoneOk ? "None" : "Error");

        if (!ensureAtLeastOneContactIfAnyEnabled(oModel)) {
          sap.m.MessageToast.show("Select an email or phone number if any preferences are enabled.");
          return false;
        }
        if (!emailOk || !phoneOk) {
          sap.m.MessageToast.show("Fix invalid email/phone selections before saving.");
          return false;
        }
        return true;
      }

      const oSaveBtn = new sap.m.Button({
        text: "Save",
        type: "Emphasized",
        icon: "sap-icon://save",
        press: function () {
          if (!validateBeforeSave()) return;
          const data = oModel.getData();
          data.meta.lastSavedAt = formatNow();
          oModel.refresh(true);
          saveState(data);
          sap.m.MessageToast.show("Saved");
        }
      });

      const oCancelBtn = new sap.m.Button({
        text: "Cancel",
        icon: "sap-icon://decline",
        type: "Transparent",
        press: function () {
          sap.m.MessageBox.confirm("Discard unsaved changes?", {
            onClose: function (action) {
              if (action !== sap.m.MessageBox.Action.OK) return;

              const loaded = loadState();
              const revert = loaded ? loaded : defaultState;

              // normalize on cancel too
              revert.customer = revert.customer || {};
              revert.customer.emailsOnFile = normalizeValueList(revert.customer.emailsOnFile ?? defaultState.customer.emailsOnFile);
              revert.customer.phonesOnFile = normalizeValueList(revert.customer.phonesOnFile ?? defaultState.customer.phonesOnFile);
              if (!revert.customer.email) revert.customer.email = (revert.customer.emailsOnFile[0]?.value) || "";
              if (!revert.customer.phone) revert.customer.phone = (revert.customer.phonesOnFile[0]?.value) || "";

              oModel.setData(JSON.parse(JSON.stringify(revert)));
              sap.m.MessageToast.show("Changes discarded");
            }
          });
        }
      });

      const oActionBar = new sap.m.Toolbar({
        content: [
          oSaveBtn,
          oCancelBtn,
          new sap.m.ToolbarSpacer(),
          oLastSaved
        ]
      });

      // ----------------------------
      // Layout
      // ----------------------------
      const oPage = new sap.m.Page({
        title: "Preferences",
        content: [
          new sap.m.VBox({
            width: "100%",
            items: [
              new sap.m.VBox({ items: [oTitle, oSub] }).addStyleClass("sapUiSmallMarginBottom"),
              oContactCard,
              new sap.m.Toolbar({ content: [ new sap.m.Title({ text: "" }) ] }).addStyleClass("sapUiTinyMarginTop"),
              oTable
            ]
          }).addStyleClass("pageWrap sapUiSmallMargin")
        ],
        footer: oActionBar
      });

      const oApp = new sap.m.App({ pages: [oPage] });
      oApp.setModel(oModel);
      oApp.placeAt("content");
    });
  </script>
</body>
</html>


