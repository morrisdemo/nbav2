<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Communication Preferences</title>

  <script
    id="sap-ui-bootstrap"
    src="https://sdk.openui5.org/resources/sap-ui-core.js"
    data-sap-ui-theme="sap_horizon"
    data-sap-ui-libs="sap.m,sap.ui.layout"
    data-sap-ui-async="true"
    data-sap-ui-compatVersion="edge"
    data-sap-ui-preload="async"
  ></script>

  <style>
    html, body, #content { height: 100%; margin: 0; }
    .pageWrap { max-width: 1200px; margin: 0 auto; }
    .muted { opacity: 0.75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tinyTopPad { padding-top: 0.25rem; }
  </style>
</head>

<body class="sapUiBody sapUiSizeCompact">
  <div id="content"></div>

  <script>
    sap.ui.getCore().attachInit(function () {

      const CHANNELS = [
        { key: "EMAIL", label: "Email" },
        { key: "SMS", label: "SMS" },
        { key: "PUSH", label: "In-App Push" },
        { key: "VOICE", label: "Voice Call" },
        { key: "MAIL", label: "Mail" }
      ];

      const PROCESSES = [
        { id: "BILLING_PAYMENTS", title: "Billing & Payments", desc: "Statements, bills, payment reminders, confirmations." },
        { id: "USAGE_ALERTS", title: "Usage Alerts", desc: "High usage, threshold alerts, leak alerts (if applicable)." },
        { id: "OUTAGES", title: "Outages", desc: "Service interruptions, restoration updates, emergency notices." },
        { id: "PROGRAM_RECS", title: "Program Recommendations", desc: "Rebates, assistance programs, time-of-use suggestions." },
        { id: "PROFILE_UPDATES", title: "Profile Updates", desc: "Account changes, security notices, preference confirmations." }
      ];

      const STORAGE_KEY = "scv2_comm_prefs_v2";

      function newBlankPrefs() {
        return PROCESSES.map(p => ({
          processId: p.id,
          processTitle: p.title,
          channels: CHANNELS.reduce((acc, c) => (acc[c.key] = false, acc), {}),
          // NEW: per-process contact targets (so switches know *which* email/phone you enabled)
          contactTargets: {
            emailMode: "DEFAULT",     // DEFAULT | SPECIFIC
            emailValue: "",           // if SPECIFIC, hold the chosen email
            phoneMode: "DEFAULT",     // DEFAULT | SPECIFIC
            phoneValue: ""            // if SPECIFIC, hold the chosen phone
          },
          notes: ""
        }));
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      }

      function saveState(state) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state, null, 2));
      }

      function formatNow() {
        return new Date().toLocaleString();
      }

      function isValidEmail(v) {
        if (!v) return true;
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v).trim());
      }

      function isValidPhone(v) {
        if (!v) return true;
        return /^[0-9()+\-.\s]{7,}$/.test(String(v).trim());
      }

      function ensureAtLeastOneContactIfAnyEnabled() {
        const data = oModel.getData();
        const anyEnabled = data.preferences.some(row =>
          Object.values(row.channels || {}).some(Boolean)
        );
        if (!anyEnabled) return true;

        const hasDefaultEmail = !!(data.customer.defaultEmail || "").trim();
        const hasDefaultPhone = !!(data.customer.defaultPhone || "").trim();

        // If any comms are enabled, require at least one default contact OR at least one on-file entry
        const hasAnyEmail = hasDefaultEmail || (data.customer.emailsOnFile || []).length > 0;
        const hasAnyPhone = hasDefaultPhone || (data.customer.phonesOnFile || []).length > 0;

        return hasAnyEmail || hasAnyPhone;
      }

      function buildExportJson() {
        const data = oModel.getData();
        return {
          customer: {
            preferredName: data.customer.preferredName,
            defaultEmail: data.customer.defaultEmail,
            defaultPhone: data.customer.defaultPhone,
            emailsOnFile: data.customer.emailsOnFile,
            phonesOnFile: data.customer.phonesOnFile
          },
          global: data.global,
          preferences: data.preferences.map(p => ({
            processId: p.processId,
            channels: p.channels,
            contactTargets: p.contactTargets,
            notes: p.notes || ""
          })),
          meta: data.meta
        };
      }

      // ----------------------------
      // Default state (DEMO emails/phones "on file")
      // ----------------------------
      const defaultState = {
        customer: {
          preferredName: "",
          // NEW: default email/phone (the “primary”)
          defaultEmail: "alex.primary@email.com",
          defaultPhone: "+1 (916) 555-0123",

          // NEW: other emails/phones on file
          emailsOnFile: [
            "alex.primary@email.com",
            "alex.work@email.com",
            "alex.family@email.com"
          ],
          phonesOnFile: [
            "+1 (916) 555-0123",
            "+1 (916) 555-0456"
          ]
        },
        global: {
          allowMarketing: false,
          quietHours: { enabled: false, start: "21:00", end: "08:00" }
        },
        preferences: newBlankPrefs(),
        meta: {
          lastSavedAt: "",
          version: "2.0"
        }
      };

      // Load persisted if exists
      const persisted = loadState();
      const state = persisted ? persisted : defaultState;

      // If older saved data exists (v1), lightly upgrade it
      if (state && state.preferences) {
        state.preferences.forEach(p => {
          if (!p.contactTargets) {
            p.contactTargets = { emailMode: "DEFAULT", emailValue: "", phoneMode: "DEFAULT", phoneValue: "" };
          }
        });
      }

      const oModel = new sap.ui.model.json.JSONModel(state);
      oModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);

      // ----------------------------
      // Header / contact card
      // ----------------------------
      const oTitle = new sap.m.Title({ text: "Communication Preferences", level: "H2" });
      const oSub = new sap.m.Text({
        text: "Select your default contact info, and optionally choose a specific email/phone per business process."
      }).addStyleClass("muted tinyTopPad");

      // "Default Email" as a Select from emails on file (so you can set the default)
      const oDefaultEmailSelect = new sap.m.Select({
        selectedKey: "{/customer/defaultEmail}",
        width: "100%",
        items: {
          path: "/customer/emailsOnFile",
          template: new sap.ui.core.Item({ key: "{= ${$source>}.toString() }", text: "{$source>}" }),
          templateShareable: false
        },
        change: function () {
          // If any row is using DEFAULT email and had a stale specific, keep as-is.
          // No extra action needed because DEFAULT reads /customer/defaultEmail at export time.
        }
      });

      // Allow adding a new email to the "on file" list in-demo
      const oAddEmailInput = new sap.m.Input({ placeholder: "Add another email…", width: "100%" });
      const oAddEmailBtn = new sap.m.Button({
        text: "Add",
        type: "Transparent",
        press: function () {
          const v = (oAddEmailInput.getValue() || "").trim();
          if (!v || !isValidEmail(v)) {
            sap.m.MessageToast.show("Enter a valid email to add.");
            return;
          }
          const data = oModel.getData();
          data.customer.emailsOnFile = data.customer.emailsOnFile || [];
          if (!data.customer.emailsOnFile.includes(v)) data.customer.emailsOnFile.push(v);
          // If no default, set it
          if (!data.customer.defaultEmail) data.customer.defaultEmail = v;
          oModel.refresh(true);
          oAddEmailInput.setValue("");
          sap.m.MessageToast.show("Email added");
        }
      });

      // "Default Phone" as a Select from phones on file
      const oDefaultPhoneSelect = new sap.m.Select({
        selectedKey: "{/customer/defaultPhone}",
        width: "100%",
        items: {
          path: "/customer/phonesOnFile",
          template: new sap.ui.core.Item({ key: "{= ${$source>}.toString() }", text: "{$source>}" }),
          templateShareable: false
        }
      });

      const oAddPhoneInput = new sap.m.Input({ placeholder: "Add another phone…", width: "100%" });
      const oAddPhoneBtn = new sap.m.Button({
        text: "Add",
        type: "Transparent",
        press: function () {
          const v = (oAddPhoneInput.getValue() || "").trim();
          if (!v || !isValidPhone(v)) {
            sap.m.MessageToast.show("Enter a valid phone to add.");
            return;
          }
          const data = oModel.getData();
          data.customer.phonesOnFile = data.customer.phonesOnFile || [];
          if (!data.customer.phonesOnFile.includes(v)) data.customer.phonesOnFile.push(v);
          if (!data.customer.defaultPhone) data.customer.defaultPhone = v;
          oModel.refresh(true);
          oAddPhoneInput.setValue("");
          sap.m.MessageToast.show("Phone added");
        }
      });

      const oPreferredName = new sap.m.Input({
        value: "{/customer/preferredName}",
        placeholder: "Optional (e.g., Alex)",
        width: "100%"
      });

      const oAllowMarketing = new sap.m.Switch({ state: "{/global/allowMarketing}" });
      const oQuietHoursSwitch = new sap.m.Switch({ state: "{/global/quietHours/enabled}" });

      const oQuietStart = new sap.m.TimePicker({
        value: "{/global/quietHours/start}",
        displayFormat: "HH:mm",
        valueFormat: "HH:mm",
        width: "100%"
      });

      const oQuietEnd = new sap.m.TimePicker({
        value: "{/global/quietHours/end}",
        displayFormat: "HH:mm",
        valueFormat: "HH:mm",
        width: "100%"
      });

      const oContactForm = new sap.ui.layout.form.SimpleForm({
        editable: true,
        layout: "ResponsiveGridLayout",
        labelSpanXL: 4, labelSpanL: 4, labelSpanM: 4, labelSpanS: 12,
        columnsXL: 2, columnsL: 2, columnsM: 2,
        content: [
          new sap.m.Label({ text: "Preferred Name" }), oPreferredName,

          new sap.m.Label({ text: "Default Email" }), oDefaultEmailSelect,
          new sap.m.Label({ text: "Add Email" }),
          new sap.m.HBox({ width: "100%", items: [oAddEmailInput, oAddEmailBtn] }),

          new sap.m.Label({ text: "Default Phone" }), oDefaultPhoneSelect,
          new sap.m.Label({ text: "Add Phone" }),
          new sap.m.HBox({ width: "100%", items: [oAddPhoneInput, oAddPhoneBtn] }),

          new sap.m.Label({ text: "Allow Program/Offer Recommendations" }), oAllowMarketing,

          new sap.m.Label({ text: "Quiet Hours" }), oQuietHoursSwitch,
          new sap.m.Label({ text: "Quiet Hours Start" }), oQuietStart,
          new sap.m.Label({ text: "Quiet Hours End" }), oQuietEnd
        ]
      });

      const oContactCard = new sap.m.Panel({
        headerText: "Contact & Global Settings",
        content: [oContactForm]
      });

      // ----------------------------
      // Preferences Table
      // ----------------------------
      const oTable = new sap.m.Table({
        inset: false,
        growing: true,
        growingScrollToLoad: true,
        sticky: ["ColumnHeaders"],
        headerToolbar: new sap.m.Toolbar({
          content: [
            new sap.m.Title({ text: "Preferences by Process & Channel", level: "H3" }),
            new sap.m.ToolbarSpacer(),
            new sap.m.Button({
              text: "Enable All",
              type: "Transparent",
              press: function () {
                const data = oModel.getData();
                data.preferences.forEach(r => Object.keys(r.channels).forEach(k => r.channels[k] = true));
                oModel.refresh(true);
              }
            }),
            new sap.m.Button({
              text: "Disable All",
              type: "Transparent",
              press: function () {
                const data = oModel.getData();
                data.preferences.forEach(r => Object.keys(r.channels).forEach(k => r.channels[k] = false));
                oModel.refresh(true);
              }
            })
          ]
        })
      });

      // Columns: Process | channel switches... | Email Target | Phone Target | Notes
      oTable.addColumn(new sap.m.Column({ width: "18rem", header: new sap.m.Text({ text: "Process" }) }));
      CHANNELS.forEach(c => oTable.addColumn(new sap.m.Column({ hAlign: "Center", header: new sap.m.Text({ text: c.label }) })));

      oTable.addColumn(new sap.m.Column({ width: "14rem", header: new sap.m.Text({ text: "Email Target" }) }));
      oTable.addColumn(new sap.m.Column({ width: "14rem", header: new sap.m.Text({ text: "Phone Target" }) }));
      oTable.addColumn(new sap.m.Column({ width: "14rem", header: new sap.m.Text({ text: "Notes" }) }));

      function channelSwitchTemplate(channelKey) {
        return new sap.m.Switch({
          state: `{channels/${channelKey}}`,
          customTextOn: "On",
          customTextOff: "Off"
        });
      }

      function emailTargetCell() {
        const modeSelect = new sap.m.Select({
          selectedKey: "{contactTargets/emailMode}",
          width: "100%",
          items: [
            new sap.ui.core.Item({ key: "DEFAULT", text: "Use Default Email" }),
            new sap.ui.core.Item({ key: "SPECIFIC", text: "Pick Specific Email" })
          ],
          change: function (e) {
            const ctx = e.getSource().getBindingContext();
            const row = ctx.getObject();
            if (e.getParameter("selectedItem").getKey() === "DEFAULT") {
              row.contactTargets.emailValue = "";
              oModel.refresh(true);
            } else {
              // if switching to SPECIFIC and none set, default to current defaultEmail
              const data = oModel.getData();
              row.contactTargets.emailValue = row.contactTargets.emailValue || data.customer.defaultEmail || "";
              oModel.refresh(true);
            }
          }
        });

        const specificSelect = new sap.m.Select({
          selectedKey: "{contactTargets/emailValue}",
          width: "100%",
          enabled: "{= ${contactTargets/emailMode} === 'SPECIFIC' }",
          items: {
            path: "/customer/emailsOnFile",
            template: new sap.ui.core.Item({ key: "{= ${$source>}.toString() }", text: "{$source>}" }),
            templateShareable: false
          }
        });

        return new sap.m.VBox({ items: [modeSelect, specificSelect] });
      }

      function phoneTargetCell() {
        const modeSelect = new sap.m.Select({
          selectedKey: "{contactTargets/phoneMode}",
          width: "100%",
          items: [
            new sap.ui.core.Item({ key: "DEFAULT", text: "Use Default Phone" }),
            new sap.ui.core.Item({ key: "SPECIFIC", text: "Pick Specific Phone" })
          ],
          change: function (e) {
            const ctx = e.getSource().getBindingContext();
            const row = ctx.getObject();
            if (e.getParameter("selectedItem").getKey() === "DEFAULT") {
              row.contactTargets.phoneValue = "";
              oModel.refresh(true);
            } else {
              const data = oModel.getData();
              row.contactTargets.phoneValue = row.contactTargets.phoneValue || data.customer.defaultPhone || "";
              oModel.refresh(true);
            }
          }
        });

        const specificSelect = new sap.m.Select({
          selectedKey: "{contactTargets/phoneValue}",
          width: "100%",
          enabled: "{= ${contactTargets/phoneMode} === 'SPECIFIC' }",
          items: {
            path: "/customer/phonesOnFile",
            template: new sap.ui.core.Item({ key: "{= ${$source>}.toString() }", text: "{$source>}" }),
            templateShareable: false
          }
        });

        return new sap.m.VBox({ items: [modeSelect, specificSelect] });
      }

      const oItemTemplate = new sap.m.ColumnListItem({
        vAlign: "Middle",
        cells: [
          new sap.m.VBox({
            items: [
              new sap.m.Text({ text: "{processTitle}" }),
              new sap.m.Text({
                text: {
                  path: "processId",
                  formatter: function (pid) {
                    const p = PROCESSES.find(x => x.id === pid);
                    return p ? p.desc : "";
                  }
                }
              }).addStyleClass("muted")
            ]
          }),
          ...CHANNELS.map(c => new sap.m.HBox({ justifyContent: "Center", items: [channelSwitchTemplate(c.key)] })),

          // NEW: row-level targets
          emailTargetCell(),
          phoneTargetCell(),

          new sap.m.Input({ value: "{notes}", placeholder: "Optional…", width: "100%" })
        ]
      });

      oTable.bindItems({
        path: "/preferences",
        template: oItemTemplate,
        templateShareable: false
      });

      // ----------------------------
      // Footer actions
      // ----------------------------
      const oLastSaved = new sap.m.Text({
        text: {
          path: "/meta/lastSavedAt",
          formatter: function (v) { return v ? `Last saved: ${v}` : "Not saved yet"; }
        }
      }).addStyleClass("muted");

      const oExportArea = new sap.m.TextArea({
        rows: 10,
        width: "100%",
        growing: true,
        growingMaxLines: 16,
        value: "",
        editable: false
      }).addStyleClass("mono");

      const oExportDialog = new sap.m.Dialog({
        title: "Export Preferences (JSON)",
        contentWidth: "760px",
        content: [
          new sap.m.Text({ text: "Copy/paste this JSON to send to an API, workflow, or middleware." }).addStyleClass("muted"),
          oExportArea
        ],
        beginButton: new sap.m.Button({ text: "Close", press: function () { oExportDialog.close(); } })
      });

      function validateBeforeSave() {
        const data = oModel.getData();

        const emailOk = isValidEmail(data.customer.defaultEmail);
        const phoneOk = isValidPhone(data.customer.defaultPhone);

        if (!emailOk) sap.m.MessageToast.show("Default Email looks invalid.");
        if (!phoneOk) sap.m.MessageToast.show("Default Phone looks invalid.");

        if (!ensureAtLeastOneContactIfAnyEnabled()) {
          sap.m.MessageToast.show("Add at least one email or phone if any preferences are enabled.");
          return false;
        }

        // If a row is SPECIFIC, make sure it has a chosen value
        for (const row of data.preferences) {
          if (row.contactTargets?.emailMode === "SPECIFIC" && !row.contactTargets.emailValue) {
            sap.m.MessageToast.show(`Pick a specific email for "${row.processTitle}".`);
            return false;
          }
          if (row.contactTargets?.phoneMode === "SPECIFIC" && !row.contactTargets.phoneValue) {
            sap.m.MessageToast.show(`Pick a specific phone for "${row.processTitle}".`);
            return false;
          }
        }

        return emailOk && phoneOk;
      }

      const oSaveBtn = new sap.m.Button({
        text: "Save",
        type: "Emphasized",
        icon: "sap-icon://save",
        press: function () {
          if (!validateBeforeSave()) return;
          const data = oModel.getData();
          data.meta.lastSavedAt = formatNow();
          oModel.refresh(true);
          saveState(data);
          sap.m.MessageToast.show("Saved");
        }
      });

      const oResetBtn = new sap.m.Button({
        text: "Reset",
        icon: "sap-icon://reset",
        type: "Transparent",
        press: function () {
          sap.m.MessageBox.confirm("Reset all fields to defaults?", {
            onClose: function (action) {
              if (action !== sap.m.MessageBox.Action.OK) return;
              oModel.setData(JSON.parse(JSON.stringify(defaultState)));
              localStorage.removeItem(STORAGE_KEY);
              sap.m.MessageToast.show("Reset complete");
            }
          });
        }
      });

      const oExportBtn = new sap.m.Button({
        text: "Export JSON",
        icon: "sap-icon://download",
        type: "Transparent",
        press: function () {
          oExportArea.setValue(JSON.stringify(buildExportJson(), null, 2));
          oExportDialog.open();
        }
      });

      const oLoadBtn = new sap.m.Button({
        text: "Load Saved",
        icon: "sap-icon://refresh",
        type: "Transparent",
        press: function () {
          const loaded = loadState();
          if (!loaded) return sap.m.MessageToast.show("No saved preferences found.");
          // Light upgrade
          loaded.preferences?.forEach(p => {
            if (!p.contactTargets) p.contactTargets = { emailMode: "DEFAULT", emailValue: "", phoneMode: "DEFAULT", phoneValue: "" };
          });
          oModel.setData(loaded);
          sap.m.MessageToast.show("Loaded");
        }
      });

      const oActionBar = new sap.m.Toolbar({
        content: [
          oSaveBtn,
          oResetBtn,
          new sap.m.ToolbarSpacer(),
          oLastSaved,
          new sap.m.ToolbarSpacer(),
          oLoadBtn,
          oExportBtn
        ]
      });

      // ----------------------------
      // Page layout
      // ----------------------------
      const oPage = new sap.m.Page({
        title: "Preferences",
        content: [
          new sap.m.VBox({
            width: "100%",
            items: [
              new sap.m.VBox({ items: [oTitle, oSub] }).addStyleClass("sapUiSmallMarginBottom"),
              oContactCard,
              new sap.m.Toolbar({ content: [ new sap.m.Title({ text: "" }) ] }).addStyleClass("sapUiTinyMarginTop"),
              oTable
            ]
          }).addStyleClass("pageWrap sapUiSmallMargin")
        ],
        footer: oActionBar
      });

      const oApp = new sap.m.App({ pages: [oPage] });
      oApp.setModel(oModel);
      oApp.placeAt("content");
    });
  </script>
</body>
</html>

